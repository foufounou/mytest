language: cpp
dist: trusty


jobs:
    include:
        - os: linux
          dist: trusty
          env: _DIST=trusty
        #- os: linux
          #dist: xenial
          #env: _DIST=xenial
        #- os: linux
          #dist: bionic
          #env: _DIST=bionic

branches:
    only:
        - master

before_install:
- if [[ "${TRAVIS_OS_NAME}" == linux ]]; then sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test ; fi
- if [[ "${_DIST}" == trusty ]]; then sudo add-apt-repository ppa:beineri/opt-qt597-trusty -y ; fi
- if [ "${_DIST}" == xenial ] || [ "${_DIST}" == bionic ] ; then sudo add-apt-repository ppa:beineri/opt-qt-5.12.2-$_DIST -y ; fi
- if [[ "${TRAVIS_OS_NAME}" == linux ]]; then sudo apt-get update -qq ; fi


install:
- if [[ "${TRAVIS_OS_NAME}" == linux ]]; then sudo apt-get -y install software-properties-common checkinstall xvfb dh-make fakeroot gpgv2 tree g++-8 ; fi
- if [[ "${TRAVIS_OS_NAME}" == linux ]]; then export CC=gcc-8 && export CXX=g++-8 ; fi
- if [[ "${_DIST}" == trusty ]]; then sudo apt-get install -qq qt59-meta-minimal && source /opt/qt59/bin/qt59-env.sh ; fi
- if [ "${_DIST}" == xenial ] || [ "${_DIST}" == bionic ] ; then sudo apt-get install -qq qt512-meta-minimal && source /opt/qt512/bin/qt512-env.sh ; fi
- cat /opt/qt5*/bin/qt*-env.sh


before_script:
- qmake


script:
- make -j$(nproc)


after_success:
- mkdir -p appimage/mytest/usr/bin
- cp mytest appimage/mytest/usr/bin
- cp -t appimage/mytest/ mytest.desktop mytest.png LICENSE
- wget -c https://github.com/probonopd/linuxdeployqt/releases/download/5/linuxdeployqt-5-x86_64.AppImage
- chmod +x linuxdeployqt-5-x86_64.AppImage
- if [[ "${_DIST}" != bionic ]]; then ./linuxdeployqt-5-x86_64.AppImage appimage/mytest/usr/bin/mytest -appimage ; fi
- echo $PWD
- tree .
- ld -v
- ls -l /opt/qt5*/lib/libQt5Core.so.5
- ldd mytest


#deploy:
  #provider: releases
  #draft: true
  #edge: true
  #cleanup: true
  #token: $GITHUB_TOKEN
  #file:
   #- mytest
  #file_glob: true
  #on:
    #repo: foufounou/mytest
    #tags: false
